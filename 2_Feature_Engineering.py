import pandas as pd
import numpy as np
import sys
import os

# =======================================
# 1. íŒŒë¼ë¯¸í„° ì„¤ì •
# =======================================
# ğŸš¨ ì—¬ê¸°ê°€ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤! 
# ì´ ìœˆë„ìš° í¬ê¸°ë¥¼ 30, 45, 60 ë“±ìœ¼ë¡œ ë°”ê¿”ê°€ë©°
# ëª¨ë¸ì˜ ì„±ëŠ¥ì´ ì–´ë–»ê²Œ ë³€í•˜ëŠ”ì§€ ì‹¤í—˜(íŠœë‹)í•˜ê²Œ ë©ë‹ˆë‹¤.
WINDOW_SIZE = 14  

INPUT_FILE = "unified_dataset.csv"
OUTPUT_FILE = f"features_dataset_{WINDOW_SIZE}d.csv"

# =======================================
# 2. í†µí•© ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
# =======================================
print(f"[INFO] 1ë‹¨ê³„ì—ì„œ í†µí•©ëœ ë°ì´í„° '{INPUT_FILE}'ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤...")
if not os.path.exists(INPUT_FILE):
    print(f"[ERROR] '{INPUT_FILE}'ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    print("       ë¨¼ì € 1ë‹¨ê³„(unify) ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.")
    sys.exit()

# 'date' ì»¬ëŸ¼ì„ ì¸ë±ìŠ¤ë¡œ, ë‚ ì§œ í˜•ì‹ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
final_dataset = pd.read_csv(INPUT_FILE, index_col='date', parse_dates=True)
print(f"       ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ. Shape: {final_dataset.shape}")

# =======================================
# 3. í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§ (ìŠ¬ë¼ì´ë”© ìœˆë„ìš°)
# =======================================
# 

print(f"[INFO] {WINDOW_SIZE}ì¼ ë¡¤ë§ ìœˆë„ìš° í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤...")

# 01~20 EventRootCode ì»¬ëŸ¼ ëª©ë¡
features = [str(i).zfill(2) for i in range(1, 21)]

# ìƒì„±ëœ í”¼ì²˜ë¥¼ ë‹´ì„ ìƒˆ ë°ì´í„°í”„ë ˆì„
df_features = pd.DataFrame(index=final_dataset.index)

# 20ê°œ ì½”ë“œì— ëŒ€í•´ ë¡¤ë§(Rolling) í†µê³„ ê³„ì‚°
for col in features:
    if col in final_dataset.columns:
        # 30ì¼ ì´ë™ í‰ê·  (ìµœê·¼ 30ì¼ì˜ í‰ê· ì ì¸ ê°’)
        df_features[f'{col}_mean_{WINDOW_SIZE}d'] = final_dataset[col].rolling(window=WINDOW_SIZE).mean()
        
        # 30ì¼ ì´ë™ í‘œì¤€í¸ì°¨ (ìµœê·¼ 30ì¼ì˜ ë³€ë™ì„±)
        df_features[f'{col}_std_{WINDOW_SIZE}d'] = final_dataset[col].rolling(window=WINDOW_SIZE).std()
    else:
        print(f"[WARNING] '{col}' ì»¬ëŸ¼ì´ ì›ë³¸ ë°ì´í„°ì— ì—†ìŠµë‹ˆë‹¤. ê±´ë„ˆëœë‹ˆë‹¤.")

print("       ë¡¤ë§ í†µê³„ ê³„ì‚° ì™„ë£Œ.")

# =======================================
# 4. ë ˆì´ë¸”(ì •ë‹µ) ë³µì‚¬
# =======================================
# 'is_anomaly' (ì •ë‹µ) ì»¬ëŸ¼ì€ í”¼ì²˜ê°€ ì•„ë‹ˆë¯€ë¡œ ê·¸ëŒ€ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤.
df_features['is_anomaly'] = final_dataset['is_anomaly']

# =======================================
# 5. ê²°ì¸¡ì¹˜(NaN) ì œê±°
# =======================================
# ë¡¤ë§ ìœˆë„ìš° íŠ¹ì„±ìƒ, ë°ì´í„°ì˜ ë§¨ ì²˜ìŒ (WINDOW_SIZE - 1)ì¼ (ì¦‰, 29ì¼)
# ë™ì•ˆì€ í†µê³„ ê³„ì‚°ì´ ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ NaN(ê²°ì¸¡ì¹˜)ì´ ë°œìƒí•©ë‹ˆë‹¤.
# ì´ ê°’ë“¤ì€ ëª¨ë¸ í•™ìŠµì— ì‚¬ìš©í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë°˜ë“œì‹œ ì œê±°í•´ì•¼ í•©ë‹ˆë‹¤.
print(f"\n[INFO] ê²°ì¸¡ì¹˜(NaN) ì œê±° ì „ Shape: {df_features.shape}")
df_model_ready = df_features.dropna()
print(f"       ê²°ì¸¡ì¹˜(NaN) ì œê±° í›„ Shape: {df_model_ready.shape}")

# =======================================
# 6. ìµœì¢… íŒŒì¼ë¡œ ì €ì¥
# =======================================
# 3ë‹¨ê³„(ëª¨ë¸ í•™ìŠµ)ì—ì„œ ì‚¬ìš©í•  ìµœì¢… ë°ì´í„°ì…‹ì„ ì €ì¥í•©ë‹ˆë‹¤.
print(f"\n[INFO] í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§ ì™„ë£Œëœ ë°ì´í„°ë¥¼ '{OUTPUT_FILE}'ë¡œ ì €ì¥í•©ë‹ˆë‹¤...")
df_model_ready.to_csv(OUTPUT_FILE, index=True)

print(f"[SUCCESS] ì €ì¥ ì™„ë£Œ! '{OUTPUT_FILE}'ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
print("       ì´ì œ 3ë‹¨ê³„(ëª¨ë¸ í•™ìŠµ)ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

print("\n--- ìµœì¢… ìƒì„±ëœ ë°ì´í„° ìƒ˜í”Œ (ìƒìœ„ 5ê°œ) ---")
# 20ê°œ ì½”ë“œ * 2ê°œ í†µê³„ = 40ê°œ í”¼ì²˜ + 1ê°œ ë ˆì´ë¸” = 41ê°œ ì»¬ëŸ¼
print(df_model_ready.head())